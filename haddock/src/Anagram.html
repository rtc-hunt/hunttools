<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Anagram.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE OverloadedStrings, FlexibleInstances, Safe #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-|
<a name="line-3"></a>Module : Anagram
<a name="line-4"></a>Description : Dictionary structure and queries for anagrams.
<a name="line-5"></a>
<a name="line-6"></a>Core anagram toolkit. The main entry points are 'anagram', 'anagramAny', 'anagramMin', 'anagramFull', and 'anagramExact'. 'Histogram's are the internal form for anagram queries, and are a count of how many of each letter is present in the query.
<a name="line-7"></a>
<a name="line-8"></a>= Examples
<a name="line-9"></a>
<a name="line-10"></a>&gt;&gt;&gt; anagram ukacd "eoynkm"
<a name="line-11"></a>["monkey", "mekon", "money", ... "yon"]
<a name="line-12"></a>&gt;&gt;&gt; anagramAny ukacd "eoynkm"
<a name="line-13"></a>["monkey", "mekon", "money", ... "me", "mo", "my", ... "n", "o", "y"]
<a name="line-14"></a>&gt;&gt;&gt; anagramFull ukacd "eoynkm"
<a name="line-15"></a>["monkey"]
<a name="line-16"></a>&gt;&gt;&gt; anagramMin ukacd "eoynkm" 5
<a name="line-17"></a>["monkey", "mekon", "money"]
<a name="line-18"></a>&gt;&gt;&gt; anagramExact ukacd 5 "eoynkm"
<a name="line-19"></a>["mekon", "money"]
<a name="line-20"></a>&gt;&gt;&gt; anagramFull ukacd "?eoynk"
<a name="line-21"></a>["donkey","monkey","orkney","unyoke","yonker"]
<a name="line-22"></a>
<a name="line-23"></a>We can also use the Histogram type directly, if that happens to be convenient:
<a name="line-24"></a>
<a name="line-25"></a>&gt;&gt;&gt; Histogram 9 (replicate 26 1)
<a name="line-26"></a>histogramFromPairs 9 [('a',1),('b',1),('c',1),('d',1),('e',1),('f',1),('g',1),('h',1),('i',1),
<a name="line-27"></a>  ('j',1),('k',1),('l',1),('m',1),('n',1),('o',1),('p',1),('q',1),('r',1),('s',1),('t',1),
<a name="line-28"></a>  ('u',1),('v',1),('w',1),('x',1),('y',1),('z',1)]
<a name="line-29"></a>&gt;&gt;&gt; anagramFull onelook (Histogram 9 (replicate 26 1))
<a name="line-30"></a>["thequickbrownfoxjumpsoverthelazydog"]
<a name="line-31"></a>-}</span>
<a name="line-32"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Anagram</span> <span class='hs-layout'>(</span>
<a name="line-33"></a>        <span class='hs-conid'>Anagrammable</span><span class='hs-layout'>,</span> 
<a name="line-34"></a>        <span class='hs-comment'>-- * Main entry points</span>
<a name="line-35"></a>        <span class='hs-varid'>anagram</span><span class='hs-layout'>,</span> 
<a name="line-36"></a>        <span class='hs-varid'>anagramAny</span><span class='hs-layout'>,</span> 
<a name="line-37"></a>        <span class='hs-varid'>anagramFull</span><span class='hs-layout'>,</span> 
<a name="line-38"></a>        <span class='hs-varid'>anagramMin</span><span class='hs-layout'>,</span> 
<a name="line-39"></a>        <span class='hs-varid'>anagramExact</span><span class='hs-layout'>,</span> 
<a name="line-40"></a>        <span class='hs-comment'>-- * Lower-level programmatic interface</span>
<a name="line-41"></a>        <span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>blankCount</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>fromHistogram</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>anagramSymbols</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>getHistogram</span><span class='hs-layout'>,</span> 
<a name="line-46"></a>        <span class='hs-varid'>subHistogram</span><span class='hs-layout'>,</span> 
<a name="line-47"></a>        <span class='hs-comment'>-- * Dictionaries</span>
<a name="line-48"></a>        <span class='hs-conid'>AnagramDictionary</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnagramDictionary</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-49"></a>        <span class='hs-varid'>buildAnagramDictionary</span><span class='hs-layout'>,</span> 
<a name="line-50"></a>        <span class='hs-varid'>fromAnagramDictionary</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>DAWG</span><span class='hs-varop'>.</span><span class='hs-conid'>Packed64</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="anagramSymbols"></a><span class='hs-comment'>-- | The list of symbols we support anagramming; anything not in this list is simply dropped. We use a finite list so 'Histogram' and 'AnagramDictionary' don't need to store actual characters.</span>
<a name="line-61"></a><span class='hs-definition'>anagramSymbols</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'a'</span><span class='hs-keyglyph'>..</span><span class='hs-chr'>'z'</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="Histogram"></a><span class='hs-comment'>-- | The Histogram type; we implement anagram queries by converting the string to one of these, and querying the database for matches.</span>
<a name="line-64"></a><a name="Histogram"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Histogram</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Histogram</span> <span class='hs-layout'>{</span>
<a name="line-65"></a>  <span class='hs-comment'>-- | We differentiate internally between real letters and wildcards; the underlying code has to deal with them fully differently.</span>
<a name="line-66"></a>  <span class='hs-varid'>blankCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-67"></a>  <span class='hs-comment'>-- | the list of counts; the order is the same order as 'anagramSymbols'.</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span><span class='hs-varid'>fromHistogram</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span>
<a name="line-69"></a>  <span class='hs-layout'>}</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="histogramToString"></a><span class='hs-comment'>-- | Encode a histogram's counts as a string of chars. /not/ a string of the letters to anagram.</span>
<a name="line-72"></a><span class='hs-definition'>histogramToString</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>blanks</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toEnum</span> <span class='hs-varid'>bs</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="charCount"></a><span class='hs-definition'>charCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>blanks</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blanks</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="AnagramDictionary"></a><span class='hs-comment'>-- | A dictionary structure for querying anagrams.</span>
<a name="line-77"></a><a name="AnagramDictionary"></a><span class='hs-comment'>-- </span>
<a name="line-78"></a><a name="AnagramDictionary"></a><span class='hs-comment'>-- Internally, this is just the same sort of trie structure as 'Crossword.CrosswordDictionary', but instead of storing actual characters we treat the members as 'Word8's of letter counts, followed by the actual word. This allows us to eliminate common tails among the given words essentially for free.</span>
<a name="line-79"></a><a name="AnagramDictionary"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-conid'>Node</span>
<a name="line-80"></a><a name="fromAnagramDictionary"></a><span class='hs-comment'>-- | Get the raw trie from an AnagramDictionary.</span>
<a name="line-81"></a><span class='hs-definition'>fromAnagramDictionary</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnagramDictionary</span> <span class='hs-varid'>trie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trie</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="instance%20Show%20Histogram"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Histogram</span> <span class='hs-keyword'>where</span>
<a name="line-84"></a>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>blanks</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"histogramFromPairs "</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>blanks</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" "</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>anagramSymbols</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="histogramFromPairs"></a><span class='hs-comment'>-- | Build a histogram manually from a number of blanks and a list of character, count pairs.</span>
<a name="line-87"></a><span class='hs-definition'>histogramFromPairs</span> <span class='hs-varid'>k</span> <span class='hs-varid'>lst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>anagramSymbols</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unionBy</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>lst</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>anagramSymbols</span> <span class='hs-varop'>$</span> <span class='hs-varid'>repeat</span> <span class='hs-num'>0</span> <span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-comment'>-- | A typeclass for things that can be treated as anagram queries.</span>
<a name="line-90"></a><span class='hs-comment'>--</span>
<a name="line-91"></a><span class='hs-comment'>-- Currently, there is a 'String' instance (so you can use bare strings; also known as ['Char']) and a 'Histogram' instance, to allow lower-level access through the same functions.</span>
<a name="line-92"></a><span class='hs-keyword'>class</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-93"></a>  <span class='hs-comment'>-- | Get the query in the form of a Histogram, to actually use to access an anagram dictionary.</span>
<a name="line-94"></a>  <span class='hs-varid'>getHistogram</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>Histogram</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="instance%20(Anagrammable%20%5bChar%5d)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-97"></a>  <span class='hs-comment'>-- | If given a string, convert it to a Histogram.</span>
<a name="line-98"></a>  <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> 
<a name="line-99"></a>    <span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-chr'>'?'</span><span class='hs-layout'>)</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>let</span>
<a name="line-100"></a>       <span class='hs-varid'>q</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>fromListWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>toLower</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>|</span><span class='hs-varid'>c</span><span class='hs-keyglyph'>&lt;-</span><span class='hs-varid'>str</span><span class='hs-keyglyph'>]</span> 
<a name="line-101"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Prelude</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-num'>0</span> <span class='hs-varid'>s</span> <span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-varid'>anagramSymbols</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="instance%20(Anagrammable%20Histogram)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-conid'>Histogram</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-104"></a>  <span class='hs-comment'>-- | getHistogram = id when the type is already a Histogram.</span>
<a name="line-105"></a>  <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hist</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="subHistogram"></a><span class='hs-comment'>-- | Subtract a histogram from a histogram. "aabc" - "ab" = "ac"</span>
<a name="line-108"></a><span class='hs-definition'>subHistogram</span> <span class='hs-varid'>h</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> 
<a name="line-109"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>consumedBlanks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-varid'>clamp</span> <span class='hs-varop'>$</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromHistogram</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromHistogram</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-110"></a>     <span class='hs-keyword'>in</span> <span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span><span class='hs-varid'>blankCount</span> <span class='hs-varid'>h</span><span class='hs-comment'>-</span><span class='hs-varid'>blankCount</span> <span class='hs-varid'>r</span><span class='hs-comment'>-</span><span class='hs-varid'>consumedBlanks</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromHistogram</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromHistogram</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>clamp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>a</span><span class='hs-varop'>&lt;</span><span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-num'>0</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>a</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="buildAnagramDictionary"></a><span class='hs-comment'>-- | Construct an anagram dictionary from a raw list of strings. Gets very slow on large dictionaries, due to the time to construct the trie.</span>
<a name="line-114"></a><span class='hs-definition'>buildAnagramDictionary</span> <span class='hs-varid'>bigStringList</span> <span class='hs-keyglyph'>=</span> 
<a name="line-115"></a>  <span class='hs-conid'>AnagramDictionary</span> <span class='hs-varop'>$</span>
<a name="line-116"></a>    <span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span>
<a name="line-117"></a>      <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toEnum</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromHistogram</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-varop'>++</span><span class='hs-str'>"$"</span><span class='hs-varop'>++</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>bigStringList</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="queryAnagramDictionary"></a><span class='hs-definition'>queryAnagramDictionary</span> <span class='hs-varid'>trie</span> <span class='hs-varid'>mi</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> 
<a name="line-120"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>mii</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>mi</span><span class='hs-keyglyph'>]</span>
<a name="line-121"></a>     <span class='hs-varid'>sort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>recQuery</span> <span class='hs-varid'>mii</span> <span class='hs-layout'>(</span><span class='hs-varid'>blankCount</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromHistogram</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-varid'>trie</span>
<a name="line-122"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>recQuery</span> <span class='hs-varid'>mini</span> <span class='hs-varid'>maxi</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>tr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>mini</span><span class='hs-varop'>&gt;</span><span class='hs-num'>0</span> <span class='hs-varop'>||</span> <span class='hs-varid'>maxi</span><span class='hs-varop'>&gt;</span><span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupPrefix</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'$'</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tr</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>toList</span>
<a name="line-123"></a>        <span class='hs-varid'>recQuery</span> <span class='hs-varid'>mini</span> <span class='hs-varid'>maxi</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>tr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-124"></a>          <span class='hs-varid'>v</span><span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>clamp</span> <span class='hs-varop'>$</span> <span class='hs-varid'>a</span><span class='hs-comment'>-</span><span class='hs-varid'>mini</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>a</span><span class='hs-varop'>+</span><span class='hs-varid'>maxi</span><span class='hs-keyglyph'>]</span>
<a name="line-125"></a>          <span class='hs-varid'>next</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupPrefix</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>toEnum</span> <span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tr</span>
<a name="line-126"></a>          <span class='hs-varid'>recQuery</span> <span class='hs-layout'>(</span><span class='hs-varid'>decrem</span> <span class='hs-varid'>mini</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-comment'>-</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>decrem</span> <span class='hs-varid'>maxi</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-comment'>-</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>next</span>
<a name="line-127"></a>        <span class='hs-varid'>clamp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>a</span><span class='hs-varop'>&lt;</span><span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-num'>0</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>a</span>
<a name="line-128"></a>        <span class='hs-varid'>decrem</span> <span class='hs-varid'>allowed</span> <span class='hs-varid'>used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allowed</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-varid'>clamp</span> <span class='hs-varid'>used</span><span class='hs-layout'>)</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="queryAnagramDictionaryK"></a><span class='hs-definition'>queryAnagramDictionaryK</span> <span class='hs-varid'>trie</span> <span class='hs-varid'>mii</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> 
<a name="line-131"></a>  <span class='hs-varid'>sort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>recQuery</span> <span class='hs-varid'>mii</span> <span class='hs-layout'>(</span><span class='hs-varid'>blankCount</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromHistogram</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-varid'>trie</span>
<a name="line-132"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>recQuery</span> <span class='hs-varid'>mini</span> <span class='hs-varid'>maxi</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>tr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>mini</span><span class='hs-varop'>&gt;</span><span class='hs-num'>0</span> <span class='hs-varop'>||</span> <span class='hs-varid'>maxi</span><span class='hs-varop'>&gt;</span><span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupPrefix</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'$'</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tr</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>toList</span>
<a name="line-133"></a>        <span class='hs-varid'>recQuery</span> <span class='hs-varid'>mini</span> <span class='hs-varid'>maxi</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>tr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-134"></a>          <span class='hs-varid'>v</span><span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>clamp</span> <span class='hs-varop'>$</span> <span class='hs-varid'>a</span><span class='hs-comment'>-</span><span class='hs-varid'>mini</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>a</span><span class='hs-varop'>+</span><span class='hs-varid'>maxi</span><span class='hs-keyglyph'>]</span>
<a name="line-135"></a>          <span class='hs-varid'>next</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupPrefix</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>toEnum</span> <span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tr</span>
<a name="line-136"></a>          <span class='hs-varid'>recQuery</span> <span class='hs-layout'>(</span><span class='hs-varid'>decrem</span> <span class='hs-varid'>mini</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-comment'>-</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>decrem</span> <span class='hs-varid'>maxi</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-comment'>-</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>next</span>
<a name="line-137"></a>        <span class='hs-varid'>clamp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>a</span><span class='hs-varop'>&lt;</span><span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-num'>0</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>a</span>
<a name="line-138"></a>        <span class='hs-varid'>decrem</span> <span class='hs-varid'>allowed</span> <span class='hs-varid'>used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allowed</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-varid'>clamp</span> <span class='hs-varid'>used</span><span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a>
<a name="line-141"></a><a name="lookupHistogram"></a><span class='hs-definition'>lookupHistogram</span> <span class='hs-varid'>trie</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>queryAnagramDictionary</span> <span class='hs-varid'>trie</span> <span class='hs-num'>0</span> <span class='hs-varid'>hist</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="anagram"></a><span class='hs-comment'>-- | Basic anagram. Constrains the set of returned anagrams to use between half and all of the letters in the query.</span>
<a name="line-144"></a><span class='hs-definition'>anagram</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-145"></a><span class='hs-definition'>anagram</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span>
<a name="line-146"></a>  <span class='hs-varid'>queryAnagramDictionary</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAnagramDictionary</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>charCount</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-varop'>`quot`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-varid'>hist</span>
<a name="line-147"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>str</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="anagramAny"></a><span class='hs-comment'>-- | As 'anagram', but from all to none of the letters in the query.</span>
<a name="line-150"></a><span class='hs-definition'>anagramAny</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-151"></a><span class='hs-definition'>anagramAny</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span>
<a name="line-152"></a>  <span class='hs-varid'>queryAnagramDictionary</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAnagramDictionary</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>charCount</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-varid'>hist</span>
<a name="line-153"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>str</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="anagramMin"></a><span class='hs-comment'>-- | Anagram at-least-k letters from the query.</span>
<a name="line-156"></a><span class='hs-comment'>--</span>
<a name="line-157"></a><span class='hs-comment'>-- prop&gt; anagram dict query = anagramMin dict (length query / 2) query</span>
<a name="line-158"></a><span class='hs-comment'>--</span>
<a name="line-159"></a><span class='hs-comment'>-- prop&gt; anagramAny dict query = anagramMin dict 0 query 0</span>
<a name="line-160"></a><span class='hs-definition'>anagramMin</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-161"></a><span class='hs-definition'>anagramMin</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>min</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span>
<a name="line-162"></a>  <span class='hs-varid'>queryAnagramDictionary</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAnagramDictionary</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>charCount</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span><span class='hs-comment'>-</span><span class='hs-varid'>min</span><span class='hs-layout'>)</span> <span class='hs-varid'>hist</span>
<a name="line-163"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>str</span>
<a name="line-164"></a>
<a name="line-165"></a><a name="anagramFull"></a><span class='hs-comment'>-- | Anagram all the letters in the query.</span>
<a name="line-166"></a><span class='hs-comment'>--</span>
<a name="line-167"></a><span class='hs-comment'>-- prop&gt; anagramFull dict query = anagramMin dict query (length query)</span>
<a name="line-168"></a><span class='hs-definition'>anagramFull</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-169"></a><span class='hs-definition'>anagramFull</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>queryAnagramDictionary</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAnagramDictionary</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varid'>hist</span>
<a name="line-170"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>str</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="anagramExact"></a><span class='hs-comment'>-- | Anagram exactly k letters from the query.</span>
<a name="line-173"></a><span class='hs-comment'>--</span>
<a name="line-174"></a><span class='hs-comment'>-- prop&gt; all (\a-&gt;length a == k) (anagramExact dict k query)</span>
<a name="line-175"></a><span class='hs-definition'>anagramExact</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anagrammable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-176"></a><span class='hs-definition'>anagramExact</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>k</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>queryAnagramDictionaryK</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAnagramDictionary</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>charCount</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hist</span>
<a name="line-177"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>str</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="accblat"></a><span class='hs-definition'>accblat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Histogram</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Histogram</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-180"></a><span class='hs-definition'>accblat</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>=</span><span class='hs-keyword'>do</span>
<a name="line-181"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>histo</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>acc</span>
<a name="line-182"></a>  <span class='hs-varid'>next</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>anagramExact</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>k</span> <span class='hs-varid'>histo</span>
<a name="line-183"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>seq</span><span class='hs-varop'>++</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>next</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>histo</span> <span class='hs-varop'>`subHistogram`</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>next</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="seqAna"></a><span class='hs-comment'>-- | Very simple n-fold anagram implementation.</span>
<a name="line-186"></a><span class='hs-definition'>seqAna</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnagramDictionary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-187"></a><span class='hs-definition'>seqAna</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>str</span> <span class='hs-varid'>ints</span> <span class='hs-keyglyph'>=</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-varid'>accblat</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>getHistogram</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ints</span>
<a name="line-188"></a>
</pre></body>
</html>
